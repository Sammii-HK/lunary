# 29. CodeQL Security Audit — Remediation Plan

**Date**: 2026-02-16
**Findings**: 40 total (all WARNING level)
**Source**: Local CodeQL `javascript-security-and-quality` suite

---

## Priority 1 — High Impact / Easy Fix

### 1.1 ReDoS — `js/polynomial-redos` (3 findings)

Regex patterns that can hang on adversarial input.

| File                              | Line | Pattern                                  | Fix                                               |
| --------------------------------- | ---- | ---------------------------------------- | ------------------------------------------------- |
| `src/lib/tts/normalize-script.ts` | 65   | `/\s*\/\s*/g` in `normalizeScriptForTTS` | Replace with iterative `split('/').join(' and ')` |
| `utils/astrology/birthChart.ts`   | 424  | Regex on user-provided birth chart text  | Use `stripHtmlTags()` or iterative approach       |
| `utils/astrology/birthChart.ts`   | 469  | Same file, second regex                  | Same — iterative string processing                |

**Action**: Replace vulnerable regex with O(n) string operations. Use `stripHtmlTags()` from `@/lib/utils` where applicable.

### 1.2 Incomplete HTML Sanitization — `js/incomplete-multi-character-sanitization` (1 finding)

| File                                 | Line | Issue                                       |
| ------------------------------------ | ---- | ------------------------------------------- |
| `utils/substack/contentFormatter.ts` | 667  | `<script` can survive a single-pass replace |

**Action**: Use a loop or DOMParser-based approach so multi-character sequences like `<scr` + `ipt` can't bypass the filter. Or switch to an allow-list sanitizer (e.g. `sanitize-html` if already a dependency, otherwise iterative strip).

### 1.3 Insufficient Password Hash — `js/insufficient-password-hash` (1 finding)

| File                  | Line | Issue                              |
| --------------------- | ---- | ---------------------------------- |
| `src/lib/api/keys.ts` | 106  | API key hashed with weak algorithm |

**Action**: Investigate current hashing method. If using MD5/SHA-1/SHA-256 without salt, migrate to SHA-256 with a salt or HMAC. For API keys (not passwords), HMAC-SHA256 with a server secret is sufficient. Full bcrypt is overkill for API key lookups but would silence the finding.

---

## Priority 2 — Medium Impact

### 2.1 SSRF / Request Forgery — `js/request-forgery` (8 findings)

User-provided values flowing into fetch URLs.

| File                                          | Line |
| --------------------------------------------- | ---- |
| `src/app/api/newsletter/weekly/route.ts`      | 158  |
| `src/app/api/posts/create/route.ts`           | 99   |
| `src/app/api/substack/generate-free/route.ts` | 51   |
| + 5 more routes                               | —    |

**Action per finding**:

1. Read each route to determine what user value flows into the URL
2. Apply the allow-list pattern from CLAUDE.md — validate IDs/slugs against known-good sets
3. For internal API calls, use relative URLs (`/api/...`) instead of constructing absolute URLs
4. For external service URLs (e.g. HuggingFace, CDNs), validate the path segment against an allow-list

### 2.2 XSS — `js/xss` (3 findings)

| File                                   | Line | Issue                              |
| -------------------------------------- | ---- | ---------------------------------- |
| `src/app/api/og/moon/route.tsx`        | 74   | Query param rendered into OG image |
| `src/app/api/og/moon-circle/route.tsx` | 94   | Same pattern                       |
| `src/app/api/social/images/route.tsx`  | 212  | Same pattern                       |

**Action**: Escape query param values before embedding in JSX/HTML. These are OG image routes using `ImageResponse` — validate/sanitize inputs (e.g. allow-list moon phase names, zodiac signs) rather than passing raw query strings through.

### 2.3 Client-Side URL Redirect — `js/client-side-unvalidated-url-redirection` (3 findings)

Same files as XSS above — the query param values are also used in redirect-like contexts.

**Action**: Addressed alongside XSS fixes. Validate that redirect targets are relative or on the same origin.

### 2.4 Tainted Format String — `js/tainted-format-string` (7 findings)

| File                                             | Line |
| ------------------------------------------------ | ---- |
| `src/app/api/admin/analytics/backfill/route.ts`  | 68   |
| `src/app/api/cron/weekly-notifications/route.ts` | 62   |
| `src/app/api/video/generate/route.ts`            | 742  |
| + 4 more                                         | —    |

**Action**: These are likely template literals with user values. Sanitize by stripping control characters before interpolation, or use parameterized queries/structured logging. Admin routes behind auth are lower risk but should still be fixed.

---

## Priority 3 — Low Impact / Informational

### 3.1 Insecure Randomness — `js/insecure-randomness` (4 findings)

| File                                  | Line | Context                              |
| ------------------------------------- | ---- | ------------------------------------ |
| `src/middleware.ts`                   | 63   | Likely session/request ID generation |
| `src/lib/analytics/tracking.ts`       | 232  | Analytics event ID                   |
| `utils/astrology/chartWheelLayout.ts` | 59   | Chart rendering jitter               |
| +1 more                               | —    | —                                    |

**Action**: For `middleware.ts` if generating tokens/nonces, switch to `crypto.randomUUID()`. For analytics and chart layout, `Math.random()` is fine — these aren't security contexts. Suppress with `// codeql-suppress` comments for non-security uses.

### 3.2 Clear-Text Storage of Sensitive Data (3 findings)

| File                                                      | Line | Data                        |
| --------------------------------------------------------- | ---- | --------------------------- |
| `src/app/compatibility/.../CompatibilityClient.tsx`       | 147  | `birthDate` in localStorage |
| `src/components/grimoire/NumerologyProfileCalculator.tsx` | 114  | `birthDate` in localStorage |
| `src/lib/onboarding/prefill.ts`                           | 14   | `birthDate` in localStorage |

**Action**: Birth dates in localStorage for UX prefill is acceptable for this app (astrology tool — birth date is the core input, not a secret). Suppress these findings with inline comments explaining the rationale.

### 3.3 Identity Replacement — no-op regex (2 findings)

| File                                      | Line | Issue                                   |
| ----------------------------------------- | ---- | --------------------------------------- |
| `src/app/grimoire/zodiac/[sign]/page.tsx` | 47   | Replaces 'May' with 'May'               |
| `src/lib/social/thematic-generator.ts`    | 1194 | Replaces 'we explore' with 'we explore' |

**Action**: These are bugs in replace logic — the replacement is identical to the match. Investigate and either remove the no-op replace or fix the intended transformation.

### 3.4 XSS Through DOM — `js/xss-through-dom` (4 findings)

| File                                       | Line |
| ------------------------------------------ | ---- |
| `coverage/lcov-report/sorter.js`           | 116  |
| `coverage/sorter.js`                       | 116  |
| `src/app/admin/instagram-preview/page.tsx` | 586  |
| +1 more                                    | —    |

**Action**: The `coverage/` files are generated — add `coverage/` to `.codeqlignore`. The instagram-preview admin page should escape user content before `dangerouslySetInnerHTML` or use React's default escaping.

### 3.5 Incomplete URL Sanitization (1 finding)

| File                          | Line | Issue                        |
| ----------------------------- | ---- | ---------------------------- |
| `e2e/journeys/18-seo.spec.ts` | 421  | `schema.org` substring check |

**Action**: Test-only, no production risk. Ignore.

---

## Execution Order

```
Phase 1 (quick wins):
  [ ] Fix 3 ReDoS patterns (normalize-script.ts, birthChart.ts)
  [ ] Fix identity replacements (2 no-op replaces)
  [ ] Add .codeqlignore for coverage/ dir

Phase 2 (OG/social routes):
  [ ] Sanitize query params in 3 OG image routes (fixes XSS + redirect)
  [ ] Escape/validate social image inputs

Phase 3 (API route hardening):
  [ ] Audit and fix 8 SSRF findings with allow-lists
  [ ] Audit 7 tainted format strings

Phase 4 (crypto/hashing):
  [ ] Upgrade API key hashing in keys.ts
  [ ] Replace Math.random() in middleware.ts with crypto.randomUUID()
  [ ] Suppress Math.random() in non-security contexts

Phase 5 (cleanup):
  [ ] Fix substack HTML sanitization
  [ ] Fix instagram-preview DOM XSS
  [ ] Suppress birthDate localStorage findings with rationale
  [ ] Re-run CodeQL to verify 0 findings (or only suppressed)
```

---

## Success Criteria

- CodeQL re-scan shows 0 un-suppressed warnings
- All suppressions have inline rationale comments
- No regressions in existing tests (`/check`)
