generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("POSTGRES_URL")
  directUrl  = env("POSTGRES_URL")
  extensions = [vector, pgcrypto(map: "pgcrypto")]
}

model SocialPost {
  id                Int       @id @default(autoincrement())
  content           String
  platform          String
  postType          String    @map("post_type")
  topic             String?
  scheduledDate     DateTime? @map("scheduled_date") @db.Timestamptz(6)
  status            String    @default("pending")
  rejectionFeedback String?   @map("rejection_feedback")
  createdAt         DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime? @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  image_url         String?
  edited_content    String?
  improvement_notes String?
  video_url         String?
  week_theme        String?
  week_start        DateTime? @db.Date
  quote_id          Int?
  quote_text        String?
  quote_author      String?
  base_group_key    String?
  base_post_id      Int?
  youtube_video_id  String?
  source_type       String?
  source_id         String?
  source_title      String?
  app_feature       String?
  content_type      String?
  grimoire_slug     String?
  starfield_seed    String?
  video_metadata    Json?
  video_script      Json?

  @@index([status], map: "idx_social_posts_status")
  @@index([platform], map: "idx_social_posts_platform")
  @@index([createdAt], map: "idx_social_posts_created_at")
  @@index([scheduledDate], map: "idx_social_posts_scheduled_date")
  @@index([content_type], map: "idx_social_posts_content_type")
  @@index([grimoire_slug], map: "idx_social_posts_grimoire_slug")
  @@map("social_posts")
}

model AiThread {
  id        String    @id @default(cuid())
  userId    String    @map("user_id")
  title     String?
  messages  Json
  createdAt DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime? @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([userId], map: "idx_ai_threads_user_id")
  @@map("ai_threads")
}

model AiUsage {
  id        String    @id @default(cuid())
  userId    String    @unique @map("user_id")
  day       DateTime? @default(now()) @db.Timestamptz(6)
  count     Int?      @default(0)
  tokensIn  Int?      @default(0) @map("tokens_in")
  tokensOut Int?      @default(0) @map("tokens_out")
  plan      String
  renewedAt DateTime? @default(now()) @map("renewed_at") @db.Timestamptz(6)

  @@index([day], map: "idx_ai_usage_day")
  @@map("ai_usage")
}

model ApiKey {
  id           String    @id @default(cuid())
  keyHash      String    @unique @map("key_hash")
  keyPrefix    String    @map("key_prefix")
  userId       String    @map("user_id")
  name         String
  tier         String
  isActive     Boolean?  @default(true) @map("is_active")
  requests     Int?      @default(0)
  requestLimit Int       @map("request_limit")
  rateLimit    Int       @map("rate_limit")
  expiresAt    DateTime? @map("expires_at") @db.Timestamptz(6)
  createdAt    DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime? @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  lastUsedAt   DateTime? @map("last_used_at") @db.Timestamptz(6)
  resetAt      DateTime  @map("reset_at") @db.Timestamptz(6)

  @@index([userId], map: "idx_api_keys_user_id")
  @@index([keyHash], map: "idx_api_keys_key_hash")
  @@index([tier], map: "idx_api_keys_tier")
  @@map("api_keys")
}

model GptBridgeLog {
  id             String    @id @default(dbgenerated("gen_random_uuid()"))
  createdAt      DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  route          String
  seedRaw        String    @map("seed_raw")
  seedNormalized String    @map("seed_normalized")
  typesRequested Json      @map("types_requested")
  limit          Int
  resultCount    Int       @map("result_count")
  curatedCount   Int       @map("curated_count")
  aliasHit       Boolean   @map("alias_hit")
  searchCount    Int       @map("search_count")
  topSlugs       Json      @map("top_slugs")
  timingMs       Int       @map("timing_ms")
  cacheStatus    String?   @map("cache_status")
  level          String
  message        String
  errorName      String?   @map("error_name")
  errorMessage   String?   @map("error_message")

  @@index([createdAt(sort: Desc)], map: "idx_gpt_bridge_logs_created_at")
  @@index([seedNormalized], map: "idx_gpt_bridge_logs_seed_normalized")
  @@index([level], map: "idx_gpt_bridge_logs_level")
  @@map("gpt_bridge_logs")
}

model Testimonial {
  id          Int       @id @default(autoincrement())
  name        String
  message     String
  isPublished Boolean   @default(false) @map("is_published")
  createdAt   DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([isPublished], map: "idx_testimonials_is_published")
  @@map("testimonials")
}

model TourProgress {
  id          String       @id @default(dbgenerated("gen_random_uuid()"))
  userId      String       @map("user_id")
  tourId      String       @map("tour_id")
  status      tour_status? @default(ACTIVE)
  completedAt DateTime?    @map("completed_at") @db.Timestamptz(6)
  dismissedAt DateTime?    @map("dismissed_at") @db.Timestamptz(6)
  lastShownAt DateTime?    @default(now()) @map("last_shown_at") @db.Timestamptz(6)
  createdAt   DateTime?    @default(now()) @map("created_at") @db.Timestamptz(6)

  @@unique([userId, tourId], name: "user_tour_unique")
  @@index([userId], map: "idx_tour_progress_user_id")
  @@map("tour_progress")
}

model TestimonialPromptTracking {
  id           String    @id @default(dbgenerated("gen_random_uuid()"))
  userId       String    @unique @map("user_id")
  firstSeen    DateTime? @default(now()) @map("first_seen") @db.Timestamptz(6)
  dontAskUntil DateTime? @default(now()) @map("dont_ask_until") @db.Timestamptz(6)
  submitted    Boolean?  @default(false)
  createdAt    DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime? @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([userId], map: "idx_testimonial_prompt_user_id")
  @@index([dontAskUntil], map: "idx_testimonial_prompt_dont_ask_until")
  @@map("testimonial_prompt_tracking")
}

model account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime? @db.Timestamptz(6)
  refreshTokenExpiresAt DateTime? @db.Timestamptz(6)
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now()) @db.Timestamptz(6)
  updatedAt             DateTime  @default(now()) @db.Timestamptz(6)
  user                  user      @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([userId], map: "idx_account_userid")
}

model admin_activity_log {
  id                Int       @id @default(autoincrement())
  activity_type     String
  activity_category String
  status            String    @default("pending")
  message           String?
  metadata          Json?     @default("{}")
  error_message     String?
  execution_time_ms Int?
  created_at        DateTime? @default(now()) @db.Timestamptz(6)

  @@index([activity_category], map: "idx_admin_activity_log_category")
  @@index([created_at(sort: Desc)], map: "idx_admin_activity_log_created_at")
  @@index([status], map: "idx_admin_activity_log_status")
  @@index([activity_type], map: "idx_admin_activity_log_type")
}

model ai_prompts {
  id             Int       @id @default(autoincrement())
  user_id        String
  prompt_type    String    @db.VarChar(50)
  prompt_text    String
  cosmic_context Json?
  generated_at   DateTime  @default(now()) @db.Timestamptz(6)
  expires_at     DateTime  @db.Timestamptz(6)
  read_at        DateTime? @db.Timestamptz(6)
  created_at     DateTime  @default(now()) @db.Timestamptz(6)
  updated_at     DateTime  @default(now()) @db.Timestamptz(6)

  @@unique([user_id, prompt_type, generated_at], map: "unique_user_prompt_type_date")
  @@index([expires_at], map: "idx_ai_prompts_expires_at")
  @@index([generated_at], map: "idx_ai_prompts_generated_at")
  @@index([prompt_type], map: "idx_ai_prompts_type")
  @@index([user_id], map: "idx_ai_prompts_user_id")
}

model analytics_ai_usage {
  id            Int       @id @default(autoincrement())
  user_id       String
  session_id    String    @unique
  message_count Int?      @default(0)
  token_count   Int?      @default(0)
  mode          String?
  completed     Boolean?  @default(false)
  created_at    DateTime? @default(now()) @db.Timestamptz(6)
  completed_at  DateTime? @db.Timestamptz(6)

  @@index([created_at], map: "idx_analytics_ai_usage_created_at")
  @@index([mode], map: "idx_analytics_ai_usage_mode")
  @@index([session_id], map: "idx_analytics_ai_usage_session_id")
  @@index([user_id], map: "idx_analytics_ai_usage_user_id")
}

model analytics_conversions {
  id              Int       @id @default(autoincrement())
  user_id         String
  conversion_type String
  from_plan       String?
  to_plan         String?
  trigger_feature String?
  days_to_convert Int?
  metadata        Json?
  created_at      DateTime? @default(now()) @db.Timestamptz(6)

  @@index([created_at], map: "idx_analytics_conversions_created_at")
  @@index([trigger_feature], map: "idx_analytics_conversions_trigger_feature")
  @@index([conversion_type], map: "idx_analytics_conversions_type")
  @@index([user_id], map: "idx_analytics_conversions_user_id")
}

model analytics_discord_interactions {
  id               Int       @id @default(autoincrement())
  discord_id       String
  lunary_user_id   String?
  interaction_type String
  command_name     String?
  button_action    String?
  destination_url  String?
  source           String?   @default("discord")
  feature          String?
  campaign         String?
  metadata         Json?
  created_at       DateTime? @default(now()) @db.Timestamptz(6)

  @@index([command_name], map: "idx_analytics_discord_interactions_command")
  @@index([created_at], map: "idx_analytics_discord_interactions_created_at")
  @@index([discord_id], map: "idx_analytics_discord_interactions_discord_id")
  @@index([feature], map: "idx_analytics_discord_interactions_feature")
  @@index([lunary_user_id], map: "idx_analytics_discord_interactions_lunary_user_id")
  @@index([interaction_type], map: "idx_analytics_discord_interactions_type")
}

model analytics_identity_links {
  user_id       String
  anonymous_id  String
  first_seen_at DateTime? @default(now()) @db.Timestamptz(6)
  last_seen_at  DateTime? @default(now()) @db.Timestamptz(6)

  @@id([user_id, anonymous_id])
  @@index([anonymous_id], map: "idx_analytics_identity_links_anonymous_id")
}

model analytics_notification_events {
  id                Int       @id @default(autoincrement())
  user_id           String
  notification_type String
  event_type        String
  notification_id   String?
  metadata          Json?
  created_at        DateTime? @default(now()) @db.Timestamptz(6)

  @@index([created_at], map: "idx_analytics_notification_events_created_at")
  @@index([event_type], map: "idx_analytics_notification_events_event_type")
  @@index([notification_type], map: "idx_analytics_notification_events_type")
  @@index([user_id], map: "idx_analytics_notification_events_user_id")
}

model analytics_seo_metrics {
  id               Int       @id @default(autoincrement())
  metric_date      DateTime  @unique @db.Date
  clicks           Int?      @default(0)
  impressions      Int?      @default(0)
  ctr              Decimal?  @default(0) @db.Decimal(10, 4)
  average_position Decimal?  @default(0) @db.Decimal(10, 2)
  pages_indexed    Int?      @default(0)
  article_count    Int?      @default(0)
  top_pages        Json?
  created_at       DateTime? @default(now()) @db.Timestamptz(6)
  updated_at       DateTime? @default(now()) @db.Timestamptz(6)

  @@index([created_at], map: "idx_analytics_seo_metrics_created_at")
  @@index([metric_date], map: "idx_analytics_seo_metrics_date")
}

model analytics_user_activity {
  id             Int       @id @default(autoincrement())
  user_id        String
  activity_date  DateTime  @db.Date
  activity_type  String
  activity_count Int?      @default(1)
  metadata       Json?
  created_at     DateTime? @default(now()) @db.Timestamptz(6)

  @@unique([user_id, activity_date, activity_type])
  @@index([activity_date], map: "idx_analytics_user_activity_date")
  @@index([activity_type], map: "idx_analytics_user_activity_type")
  @@index([user_id, activity_date], map: "idx_analytics_user_activity_user_date")
  @@index([user_id], map: "idx_analytics_user_activity_user_id")
}

model app_config {
  key        String    @id
  value      String
  updated_at DateTime? @default(now()) @db.Timestamptz(6)
}

model collection_folders {
  id          Int           @id @default(autoincrement())
  user_id     String
  name        String
  description String?
  color       String?       @default("#6366f1")
  icon        String?       @default("book")
  created_at  DateTime?     @default(now()) @db.Timestamptz(6)
  updated_at  DateTime?     @default(now()) @db.Timestamptz(6)
  collections collections[]

  @@index([user_id], map: "idx_collection_folders_user_id")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model collections {
  id                 Int                 @id @default(autoincrement())
  user_id            String
  title              String
  description        String?
  category           String
  content            Json
  tags               String[]
  folder_id          Int?
  created_at         DateTime?           @default(now()) @db.Timestamptz(6)
  updated_at         DateTime?           @default(now()) @db.Timestamptz(6)
  collection_folders collection_folders? @relation(fields: [folder_id], references: [id], onUpdate: NoAction)

  @@index([category], map: "idx_collections_category")
  @@index([created_at(sort: Desc)], map: "idx_collections_created_at")
  @@index([folder_id], map: "idx_collections_folder_id")
  @@index([tags], map: "idx_collections_tags", type: Gin)
  @@index([user_id], map: "idx_collections_user_id")
}

model consent_log {
  id           Int       @id @default(autoincrement())
  user_id      String
  consent_type String
  version      String
  accepted_at  DateTime? @default(now()) @db.Timestamptz(6)
  ip_address   String?
  user_agent   String?
  metadata     Json?     @default("{}")

  @@index([accepted_at], map: "idx_consent_log_accepted_at")
  @@index([consent_type], map: "idx_consent_log_type")
  @@index([user_id], map: "idx_consent_log_user_id")
}

model content_rotation {
  id            Int       @id @default(autoincrement())
  rotation_type String
  item_id       String
  last_used_at  DateTime? @db.Timestamptz(6)
  use_count     Int?      @default(0)

  @@unique([rotation_type, item_id])
}

model conversation_snippets {
  id                Int       @id @default(autoincrement())
  user_id           String
  snippet_encrypted String
  created_at        DateTime? @default(now()) @db.Timestamptz(6)
}

model conversion_events {
  id                   Int       @id @default(autoincrement())
  event_type           String
  user_id              String?
  user_email           String?
  plan_type            String?
  trial_days_remaining Int?
  feature_name         String?
  page_path            String?
  metadata             Json?
  created_at           DateTime? @default(now()) @db.Timestamptz(6)
  anonymous_id         String?
  entity_type          String?
  entity_id            String?
  event_id             String?   @db.Uuid

  @@index([anonymous_id], map: "idx_conversion_events_anonymous_id")
  @@index([created_at], map: "idx_conversion_events_created_at")
  @@index([event_type, created_at], map: "idx_conversion_events_event_created_at")
  @@index([event_type], map: "idx_conversion_events_event_type")
  @@index([plan_type], map: "idx_conversion_events_plan_type")
  @@index([user_id, created_at], map: "idx_conversion_events_user_created_at")
  @@index([user_email], map: "idx_conversion_events_user_email")
  @@index([user_id, event_type, created_at], map: "idx_conversion_events_user_event")
  @@index([user_id], map: "idx_conversion_events_user_id")
}

model cosmic_reports {
  id          Int       @id @default(autoincrement())
  user_id     String?
  report_type String
  report_data Json
  share_token String?   @unique
  is_public   Boolean?  @default(false)
  created_at  DateTime? @default(now()) @db.Timestamptz(6)
  expires_at  DateTime? @db.Timestamptz(6)

  @@index([created_at], map: "idx_cosmic_reports_created_at")
  @@index([share_token], map: "idx_cosmic_reports_share_token")
  @@index([user_id], map: "idx_cosmic_reports_user_id")
}

model cosmic_snapshots {
  user_id       String
  snapshot_date DateTime  @db.Date
  snapshot_data Json
  created_at    DateTime? @default(now()) @db.Timestamptz(6)
  updated_at    DateTime? @default(now()) @db.Timestamptz(6)

  @@id([user_id, snapshot_date])
  @@index([snapshot_date], map: "idx_cosmic_snapshots_date")
  @@index([updated_at], map: "idx_cosmic_snapshots_updated_at")
  @@index([user_id], map: "idx_cosmic_snapshots_user_id")
}

model daily_horoscopes {
  id             Int       @id @default(autoincrement())
  user_id        String    @db.VarChar(255)
  horoscope_date DateTime  @db.Date
  horoscope_data Json
  generated_at   DateTime? @default(now()) @db.Timestamp(6)

  @@unique([user_id, horoscope_date])
}

model daily_thread_modules {
  id           Int       @id @default(autoincrement())
  user_id      String
  date         DateTime  @db.Date
  modules_json Json
  created_at   DateTime? @default(now()) @db.Timestamptz(6)
  updated_at   DateTime? @default(now()) @db.Timestamptz(6)

  @@unique([user_id, date])
  @@index([user_id, date(sort: Desc)], map: "idx_daily_thread_modules_user_date")
}

model deletion_requests {
  id            String    @id
  user_id       String    @unique
  user_email    String?
  reason        String?
  status        String    @default("pending")
  scheduled_for DateTime  @db.Timestamptz(6)
  processed_at  DateTime? @db.Timestamptz(6)
  cancelled_at  DateTime? @db.Timestamptz(6)
  created_at    DateTime? @default(now()) @db.Timestamptz(6)
  updated_at    DateTime? @default(now()) @db.Timestamptz(6)

  @@index([scheduled_for], map: "idx_deletion_requests_scheduled_for")
  @@index([status], map: "idx_deletion_requests_status")
  @@index([user_id], map: "idx_deletion_requests_user_id")
}

model discord_notification_analytics {
  id                  Int       @id @default(autoincrement())
  category            String
  event_type          String
  title               String?
  dedupe_key          String?
  sent_at             DateTime? @default(now()) @db.Timestamptz(6)
  metadata            Json?
  skipped_reason      String?
  rate_limited        Boolean?  @default(false)
  quiet_hours_skipped Boolean?  @default(false)

  @@index([category], map: "idx_discord_notification_analytics_category")
  @@index([dedupe_key], map: "idx_discord_notification_analytics_dedupe_key")
  @@index([event_type], map: "idx_discord_notification_analytics_event_type")
  @@index([sent_at], map: "idx_discord_notification_analytics_sent_at")
}

model discord_notification_log {
  id              Int       @id @default(autoincrement())
  dedupe_key      String?
  category        String
  title           String?
  recipient_count Int?      @default(0)
  sent_at         DateTime? @default(now()) @db.Timestamptz(6)

  @@index([category], map: "idx_discord_notification_log_category")
  @@index([category, sent_at], map: "idx_discord_notification_log_category_sent_at")
  @@index([dedupe_key], map: "idx_discord_notification_log_dedupe_key")
  @@index([sent_at], map: "idx_discord_notification_log_sent_at")
}

model email_events {
  id         Int       @id @default(autoincrement())
  user_id    String
  email_type String
  sent_at    DateTime? @default(now()) @db.Timestamptz(6)
  metadata   Json?

  @@unique([user_id, email_type])
  @@index([email_type], map: "idx_email_events_email_type")
  @@index([sent_at], map: "idx_email_events_sent_at")
  @@index([user_id], map: "idx_email_events_user_id")
}

model email_preferences {
  id               Int       @id @default(autoincrement())
  user_id          String    @unique
  marketing_emails Boolean?  @default(true)
  product_updates  Boolean?  @default(true)
  cosmic_insights  Boolean?  @default(true)
  trial_reminders  Boolean?  @default(true)
  weekly_digest    Boolean?  @default(true)
  unsubscribed_all Boolean?  @default(false)
  created_at       DateTime? @default(now()) @db.Timestamptz(6)
  updated_at       DateTime? @default(now()) @db.Timestamptz(6)

  @@index([user_id], map: "idx_email_preferences_user_id")
}

model global_cosmic_data {
  data_date           DateTime  @id @db.Date
  moon_phase          Json
  planetary_positions Json
  general_transits    Json
  updated_at          DateTime? @default(now()) @db.Timestamptz(6)

  @@index([data_date], map: "idx_global_cosmic_data_date")
  @@index([updated_at], map: "idx_global_cosmic_data_updated_at")
}

model grimoire_embeddings {
  id         String                 @id
  slug       String                 @unique
  title      String
  category   String
  content    String
  embedding  Unsupported("vector")?
  metadata   Json?
  created_at DateTime?              @default(now()) @db.Timestamptz(6)
  updated_at DateTime?              @default(now()) @db.Timestamptz(6)

  @@index([category], map: "idx_grimoire_embeddings_category")
  @@index([slug], map: "idx_grimoire_embeddings_slug")
}

model journal_patterns {
  id               Int       @id @default(autoincrement())
  user_id          String
  pattern_type     String
  pattern_data     Json
  generated_at     DateTime? @default(now()) @db.Timestamptz(6)
  expires_at       DateTime? @db.Timestamptz(6)
  confidence       Float?
  first_detected   DateTime? @db.Timestamptz(6)
  last_observed    DateTime? @db.Timestamptz(6)
  metadata         Json?
  pattern_category String?
  source_snapshot  String?

  @@index([user_id, pattern_type], map: "idx_journal_patterns_user_type")
  @@index([user_id, pattern_category], map: "idx_journal_patterns_user_category")
  @@index([expires_at], map: "idx_journal_patterns_expires")
  @@index([user_id], map: "idx_journal_patterns_user_id")
  @@index([pattern_data], map: "idx_journal_patterns_data", type: Gin)
}

model launch_signups {
  id         Int       @id @default(autoincrement())
  email      String    @unique
  source     String
  metadata   Json?
  created_at DateTime? @default(now()) @db.Timestamptz(6)

  @@index([created_at], map: "idx_launch_signups_created_at")
  @@index([email], map: "idx_launch_signups_email")
  @@index([source], map: "idx_launch_signups_source")
}

model legacy_fallback_usage {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id    String?
  user_email String?
  used_at    DateTime? @default(now()) @db.Timestamptz(6)
  migrated   Boolean?  @default(false)
  created_at DateTime? @default(now()) @db.Timestamptz(6)

  @@index([used_at(sort: Desc)], map: "idx_legacy_fallback_usage_used_at")
  @@index([user_email], map: "idx_legacy_fallback_usage_user_email")
  @@index([user_id], map: "idx_legacy_fallback_usage_user_id")
}

model monthly_insights {
  user_id    String
  month      Int
  year       Int
  insights   Json
  created_at DateTime? @default(now()) @db.Timestamptz(6)
  updated_at DateTime? @default(now()) @db.Timestamptz(6)

  @@id([user_id, month, year])
  @@index([year, month], map: "idx_monthly_insights_date")
  @@index([updated_at], map: "idx_monthly_insights_updated_at")
  @@index([user_id], map: "idx_monthly_insights_user_id")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model moon_circle_insights {
  id              Int          @id @default(autoincrement())
  moon_circle_id  Int
  user_id         String
  insight_text    String
  is_anonymous    Boolean?     @default(true)
  source          String?      @default("app")
  email_thread_id String?
  is_approved     Boolean?     @default(true)
  created_at      DateTime?    @default(now()) @db.Timestamptz(6)
  updated_at      DateTime?    @default(now()) @db.Timestamptz(6)
  moon_circles    moon_circles @relation(fields: [moon_circle_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([created_at(sort: Desc)], map: "idx_moon_circle_insights_created_at")
  @@index([moon_circle_id], map: "idx_moon_circle_insights_moon_circle_id")
  @@index([user_id], map: "idx_moon_circle_insights_user_id")
}

model moon_circles {
  id                   Int                    @id @default(autoincrement())
  moon_phase           String
  event_date           DateTime               @db.Date
  title                String?
  theme                String?
  description          String?
  focus_points         Json?                  @default("[]")
  rituals              Json?                  @default("[]")
  journal_prompts      Json?                  @default("[]")
  astrology_highlights Json?                  @default("[]")
  resource_links       Json?                  @default("[]")
  hero_image_url       String?
  cta_url              String?
  insight_count        Int?                   @default(0)
  created_at           DateTime?              @default(now()) @db.Timestamptz(6)
  updated_at           DateTime?              @default(now()) @db.Timestamptz(6)
  moon_circle_insights moon_circle_insights[]

  @@index([event_date(sort: Desc)], map: "idx_moon_circles_event_date")
  @@index([moon_phase], map: "idx_moon_circles_moon_phase")
}

model newsletter_subscribers {
  id                 Int       @id @default(autoincrement())
  email              String    @unique
  user_id            String?
  is_active          Boolean?  @default(true)
  is_verified        Boolean?  @default(false)
  verification_token String?
  verified_at        DateTime? @db.Timestamptz(6)
  unsubscribed_at    DateTime? @db.Timestamptz(6)
  preferences        Json?     @default("{\"blogUpdates\": true, \"cosmicAlerts\": false, \"productUpdates\": false, \"weeklyNewsletter\": true}")
  source             String?
  referrer           String?
  created_at         DateTime? @default(now()) @db.Timestamptz(6)
  updated_at         DateTime? @default(now()) @db.Timestamptz(6)
  last_email_sent    DateTime? @db.Timestamptz(6)
  email_count        Int?      @default(0)

  @@index([email], map: "idx_newsletter_subscribers_email")
  @@index([preferences], map: "idx_newsletter_subscribers_preferences", type: Gin)
  @@index([user_id], map: "idx_newsletter_subscribers_user_id")
}

model notification_sent_events {
  id             Int       @id @default(autoincrement())
  date           DateTime  @db.Date
  event_key      String
  event_type     String
  event_name     String
  event_priority Int
  sent_by        String
  sent_at        DateTime? @default(now()) @db.Timestamptz(6)

  @@unique([date, event_key])
  @@index([date], map: "idx_notification_sent_events_date")
  @@index([event_key], map: "idx_notification_sent_events_event_key")
  @@index([sent_at], map: "idx_notification_sent_events_sent_at")
}

model onboarding_completion {
  user_id         String    @id
  completed_at    DateTime? @default(now()) @db.Timestamptz(6)
  steps_completed String[]  @default([])
  skipped         Boolean?  @default(false)
  created_at      DateTime? @default(now()) @db.Timestamptz(6)
  updated_at      DateTime? @default(now()) @db.Timestamptz(6)

  @@index([completed_at], map: "idx_onboarding_completion_completed_at")
}

model pattern_analysis {
  user_id          String
  analysis_type    String
  element_patterns Json?
  color_patterns   Json?
  correlations     Json?
  timeline_data    Json?
  created_at       DateTime? @default(now()) @db.Timestamptz(6)
  updated_at       DateTime? @default(now()) @db.Timestamptz(6)

  @@id([user_id, analysis_type])
  @@index([analysis_type], map: "idx_pattern_analysis_type")
  @@index([updated_at], map: "idx_pattern_analysis_updated_at")
  @@index([user_id], map: "idx_pattern_analysis_user_id")
}

model push_subscriptions {
  id                     Int       @id @default(autoincrement())
  user_id                String?
  user_email             String?
  endpoint               String    @unique
  p256dh                 String
  auth                   String
  preferences            Json?     @default("{\"sabbats\": true, \"eclipses\": true, \"moonPhases\": true, \"retrogrades\": true, \"majorAspects\": true, \"planetaryTransits\": true}")
  user_agent             String?
  created_at             DateTime? @default(now()) @db.Timestamptz(6)
  updated_at             DateTime? @default(now()) @db.Timestamptz(6)
  last_notification_sent DateTime? @db.Timestamptz(6)
  is_active              Boolean?  @default(true)

  @@index([endpoint], map: "idx_push_subscriptions_endpoint")
  @@index([preferences], map: "idx_push_subscriptions_preferences", type: Gin)
  @@index([user_id], map: "idx_push_subscriptions_user_id")
}

model re_engagement_campaigns {
  id            Int       @id @default(autoincrement())
  user_id       String
  campaign_type String
  sent_at       DateTime? @default(now()) @db.Timestamptz(6)
  opened_at     DateTime? @db.Timestamptz(6)
  clicked_at    DateTime? @db.Timestamptz(6)
  metadata      Json?
  created_at    DateTime? @default(now()) @db.Timestamptz(6)

  @@index([sent_at], map: "idx_re_engagement_campaigns_sent_at")
  @@index([campaign_type], map: "idx_re_engagement_campaigns_type")
  @@index([user_id], map: "idx_re_engagement_campaigns_user_id")
  @@index([user_id, campaign_type, sent_at], map: "idx_re_engagement_campaigns_user_type_sent")
}

model referral_codes {
  id         Int       @id @default(autoincrement())
  code       String    @unique
  user_id    String
  created_at DateTime? @default(now()) @db.Timestamptz(6)
  uses       Int?      @default(0)
  max_uses   Int?
  campaign   String?   @db.VarChar(50)

  @@index([user_id], map: "idx_referral_codes_user_id")
}

model refund_requests {
  id                     String    @id
  user_id                String
  user_email             String?
  stripe_subscription_id String?
  stripe_customer_id     String?
  plan_type              String?
  subscription_start     DateTime? @db.Timestamptz(6)
  amount_cents           Int?
  reason                 String?
  status                 String    @default("pending")
  eligible               Boolean?
  eligibility_reason     String?
  processed_at           DateTime? @db.Timestamptz(6)
  refund_id              String?
  created_at             DateTime? @default(now()) @db.Timestamptz(6)
  updated_at             DateTime? @default(now()) @db.Timestamptz(6)

  @@index([created_at], map: "idx_refund_requests_created_at")
  @@index([status], map: "idx_refund_requests_status")
  @@index([user_id], map: "idx_refund_requests_user_id")
}

model ritual_habits {
  user_id         String
  habit_date      DateTime  @db.Date
  ritual_type     String
  completed       Boolean?  @default(false)
  completion_time DateTime? @db.Timestamptz(6)
  metadata        Json?
  created_at      DateTime? @default(now()) @db.Timestamptz(6)
  updated_at      DateTime? @default(now()) @db.Timestamptz(6)

  @@id([user_id, habit_date, ritual_type])
  @@index([habit_date], map: "idx_ritual_habits_date")
  @@index([user_id, habit_date], map: "idx_ritual_habits_user_date")
  @@index([user_id], map: "idx_ritual_habits_user_id")
}

model ritual_message_events {
  id         Int       @id @default(autoincrement())
  message_id String    @db.VarChar(100)
  context    String    @db.VarChar(50)
  user_id    String?   @default("anonymous") @db.VarChar(255)
  shown_at   DateTime? @default(now()) @db.Timestamptz(6)
  engaged    Boolean?  @default(false)
  engaged_at DateTime? @db.Timestamptz(6)

  @@index([message_id, context], map: "idx_ritual_message_performance")
  @@index([user_id, shown_at(sort: Desc)], map: "idx_ritual_message_user")
}

model session {
  id        String   @id
  expiresAt DateTime @db.Timestamptz(6)
  token     String   @unique
  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @db.Timestamptz(6)
  ipAddress String?
  userAgent String?
  userId    String
  user      user     @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([token], map: "idx_session_token")
  @@index([userId], map: "idx_session_userid")
}

model shop_packs {
  id                String    @id
  name              String
  description       String?
  category          String
  subcategory       String?
  price             Int
  stripe_product_id String?
  stripe_price_id   String?
  image_url         String?
  download_url      String?
  file_size         Int?
  is_active         Boolean?  @default(true)
  metadata          Json?
  created_at        DateTime? @default(now()) @db.Timestamptz(6)
  updated_at        DateTime? @default(now()) @db.Timestamptz(6)

  @@index([category], map: "idx_shop_packs_category")
  @@index([metadata], map: "idx_shop_packs_metadata", type: Gin)
  @@index([stripe_product_id], map: "idx_shop_packs_stripe_product_id")
}

model shop_purchases {
  id                       String    @id
  user_id                  String
  pack_id                  String
  stripe_session_id        String?
  stripe_payment_intent_id String?
  status                   String    @default("pending")
  amount                   Int
  download_token           String
  download_count           Int?      @default(0)
  max_downloads            Int?      @default(5)
  expires_at               DateTime? @db.Timestamptz(6)
  created_at               DateTime? @default(now()) @db.Timestamptz(6)
  updated_at               DateTime? @default(now()) @db.Timestamptz(6)
  pack_name                String?
  pack_slug                String?
  blob_url                 String?
  currency                 String?
  stripe_product_id        String?
  stripe_price_id          String?

  @@index([download_token], map: "idx_shop_purchases_download_token")
  @@index([pack_id], map: "idx_shop_purchases_pack_id")
  @@index([status], map: "idx_shop_purchases_status")
  @@index([stripe_session_id], map: "idx_shop_purchases_stripe_session_id")
  @@index([user_id], map: "idx_shop_purchases_user_id")
}

model social_quotes {
  id         Int       @id @default(autoincrement())
  quote_text String    @unique
  author     String?
  status     String    @default("available")
  used_at    DateTime? @db.Timestamptz(6)
  use_count  Int?      @default(0)
  created_at DateTime? @default(now()) @db.Timestamptz(6)
  updated_at DateTime? @default(now()) @db.Timestamptz(6)

  @@index([created_at], map: "idx_social_quotes_created_at")
  @@index([status], map: "idx_social_quotes_status")
  @@index([use_count], map: "idx_social_quotes_use_count")
}

model subscriptions {
  id                       Int       @id @default(autoincrement())
  user_id                  String    @unique
  user_email               String?
  user_name                String?
  status                   String    @default("free")
  plan_type                String    @default("free")
  trial_ends_at            DateTime? @db.Timestamptz(6)
  trial_reminder_3d_sent   Boolean?  @default(false)
  trial_reminder_1d_sent   Boolean?  @default(false)
  trial_expired_email_sent Boolean?  @default(false)
  stripe_customer_id       String?
  stripe_subscription_id   String?
  current_period_end       DateTime? @db.Timestamptz(6)
  created_at               DateTime? @default(now()) @db.Timestamptz(6)
  updated_at               DateTime? @default(now()) @db.Timestamptz(6)
  trial_nurture_day2_sent  Boolean?  @default(false)
  trial_nurture_day3_sent  Boolean?  @default(false)
  trial_nurture_day5_sent  Boolean?  @default(false)
  trial_nurture_day7_sent  Boolean?  @default(false)
  has_discount             Boolean?  @default(false)
  discount_percent         Decimal?  @db.Decimal(5, 2)
  monthly_amount_due       Decimal?  @db.Decimal(10, 2)
  coupon_id                String?
  is_paying                Boolean?  @default(false)
  discount_ends_at         DateTime? @db.Timestamptz(6)
  last_sync_error          String?
  last_sync_error_at       DateTime? @db.Timestamptz(6)
  promo_code               String?
  sync_error_count         Int?      @default(0)
  trial_used               Boolean?  @default(false)
  trialed_plans            String[]  @default([])
  cancel_at_period_end     Boolean?  @default(false)

  @@index([status], map: "idx_subscriptions_status")
  @@index([trial_ends_at], map: "idx_subscriptions_trial_ends_at")
  @@index([user_email], map: "idx_subscriptions_user_email")
  @@index([user_id], map: "idx_subscriptions_user_id")
  @@index([stripe_customer_id], map: "idx_subscriptions_stripe_customer_id")
  @@index([stripe_subscription_id], map: "idx_subscriptions_stripe_subscription_id")
}

model tarot_readings {
  id                 String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id            String
  spread_slug        String
  spread_name        String
  plan_snapshot      String    @default("free")
  cards              Json
  summary            String?
  highlights         Json?
  journaling_prompts Json?
  notes              String?
  tags               String[]
  metadata           Json?
  archived_at        DateTime? @db.Timestamptz(6)
  created_at         DateTime? @default(now()) @db.Timestamptz(6)
  updated_at         DateTime? @default(now()) @db.Timestamptz(6)
  ai_interpretation  String?

  @@index([created_at(sort: Desc)], map: "idx_tarot_readings_created")
  @@index([user_id], map: "idx_tarot_readings_user")
}

model theme_publications {
  id         Int       @id @default(autoincrement())
  week_start DateTime  @db.Date
  theme_name String
  created_at DateTime? @default(now()) @db.Timestamptz(6)

  @@unique([week_start, theme_name])
}

model user {
  id            String    @id
  name          String
  email         String    @unique
  emailVerified Boolean   @default(false)
  image         String?
  createdAt     DateTime  @default(now()) @db.Timestamptz(6)
  updatedAt     DateTime  @default(now()) @db.Timestamptz(6)
  account       account[]
  session       session[]

  @@index([email], map: "idx_user_email")
}

model user_attribution {
  id                   Int       @id @default(autoincrement())
  user_id              String?   @unique
  anonymous_id         String?
  first_touch_source   String?
  first_touch_medium   String?
  first_touch_campaign String?
  first_touch_keyword  String?
  first_touch_page     String?
  first_touch_referrer String?
  first_touch_at       DateTime? @db.Timestamptz(6)
  utm_source           String?
  utm_medium           String?
  utm_campaign         String?
  utm_term             String?
  utm_content          String?
  created_at           DateTime? @default(now()) @db.Timestamptz(6)
  updated_at           DateTime? @default(now()) @db.Timestamptz(6)

  @@index([created_at], map: "idx_user_attribution_created_at")
  @@index([first_touch_at], map: "idx_user_attribution_first_touch_at")
  @@index([first_touch_medium], map: "idx_user_attribution_medium")
  @@index([first_touch_source], map: "idx_user_attribution_source")
  @@index([first_touch_source, first_touch_medium], map: "idx_user_attribution_source_medium")
  @@index([user_id], map: "idx_user_attribution_user_id")
}

model user_memory {
  id                Int       @id @default(autoincrement())
  user_id           String
  category          String
  fact_encrypted    String
  confidence        Float?    @default(0.8) @db.Real
  source_message_id String?
  mentioned_count   Int?      @default(1)
  last_mentioned_at DateTime? @default(now()) @db.Timestamptz(6)
  created_at        DateTime? @default(now()) @db.Timestamptz(6)
  updated_at        DateTime? @default(now()) @db.Timestamptz(6)

  @@index([category], map: "idx_user_memory_category")
  @@index([last_mentioned_at(sort: Desc)], map: "idx_user_memory_last_mentioned")
  @@index([user_id], map: "idx_user_memory_user_id")
}

model user_notes {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id    String
  title      String
  content    String
  created_at DateTime? @default(now()) @db.Timestamptz(6)
  updated_at DateTime? @default(now()) @db.Timestamptz(6)

  @@index([created_at(sort: Desc)], map: "idx_user_notes_created_at")
  @@index([user_id], map: "idx_user_notes_user_id")
}

model user_profiles {
  id                 String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id            String    @unique
  name               String?
  birthday           String?
  birth_chart        Json?
  personal_card      Json?
  location           Json?
  stripe_customer_id String?
  created_at         DateTime? @default(now()) @db.Timestamptz(6)
  updated_at         DateTime? @default(now()) @db.Timestamptz(6)
  intention          String?
  origin_hub         String?
  origin_page        String?
  origin_type        String?
  signup_at          DateTime? @db.Timestamptz(6)

  @@index([birth_chart], map: "idx_user_profiles_birth_chart", type: Gin)
  @@index([location], map: "idx_user_profiles_location", type: Gin)
  @@index([personal_card], map: "idx_user_profiles_personal_card", type: Gin)
  @@index([stripe_customer_id], map: "idx_user_profiles_stripe_customer_id")
  @@index([user_id], map: "idx_user_profiles_user_id")
}

model user_referrals {
  id                Int       @id @default(autoincrement())
  referrer_user_id  String
  referred_user_id  String    @unique
  referral_code     String
  created_at        DateTime? @default(now()) @db.Timestamptz(6)
  reward_granted    Boolean?  @default(false)
  reward_granted_at DateTime? @db.Timestamptz(6)
  activated         Boolean?  @default(false)
  activated_at      DateTime? @db.Timestamptz(6)
  activation_event  String?   @db.VarChar(100)
  reward_tier       Int?      @default(0)

  @@index([referral_code], map: "idx_user_referrals_code")
  @@index([referred_user_id], map: "idx_user_referrals_referred")
  @@index([referrer_user_id], map: "idx_user_referrals_referrer")
}

model user_sessions {
  id                Int       @id @default(autoincrement())
  user_id           String
  session_date      DateTime  @default(dbgenerated("CURRENT_DATE")) @db.Date
  session_timestamp DateTime? @default(now()) @db.Timestamptz(6)
  page_path         String?
  feature_name      String?
  metadata          Json?
  created_at        DateTime? @default(now()) @db.Timestamptz(6)

  @@index([created_at], map: "idx_user_sessions_created_at")
  @@index([session_date], map: "idx_user_sessions_session_date")
  @@index([user_id, session_date], map: "idx_user_sessions_user_date")
  @@index([user_id], map: "idx_user_sessions_user_id")
  @@index([user_id, session_timestamp], map: "idx_user_sessions_user_timestamp")
}

model user_streaks {
  user_id               String    @id
  current_streak        Int?      @default(0)
  longest_streak        Int?      @default(0)
  last_check_in         DateTime? @db.Date
  total_check_ins       Int?      @default(0)
  created_at            DateTime? @default(now()) @db.Timestamptz(6)
  updated_at            DateTime? @default(now()) @db.Timestamptz(6)
  ritual_streak             Int?      @default(0)
  longest_ritual_streak     Int?      @default(0)
  last_ritual_date          DateTime? @db.Date
  challenge_streak          Int?      @default(0)
  longest_challenge_streak  Int?      @default(0)
  last_challenge_week       DateTime? @db.Date

  @@index([last_check_in], map: "idx_user_streaks_last_check_in")
}

/// Tracks user progress across skill trees (Tarot Mastery, Journal Keeper, Cosmic Explorer, Ritual Keeper)
/// Used for the gamification/leveling system to drive engagement
model user_progress {
  id                String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id           String
  skill_tree        String    @db.VarChar(50)
  current_level     Int       @default(1)
  total_actions     Int       @default(0)
  unlocked_features Json?     @default("[]")
  last_level_up_at  DateTime? @db.Timestamptz(6)
  created_at        DateTime  @default(now()) @db.Timestamptz(6)
  updated_at        DateTime  @default(now()) @updatedAt @db.Timestamptz(6)

  @@unique([user_id, skill_tree], map: "idx_user_progress_user_skill_unique")
  @@index([user_id], map: "idx_user_progress_user_id")
  @@index([skill_tree], map: "idx_user_progress_skill_tree")
}

model relationship_profiles {
  id                  String             @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id             String
  name                String
  relationship_type   String?
  birthday            String
  birth_time          String?
  birth_location      String?
  birth_chart         Json?
  notes               String?
  created_at          DateTime           @default(now()) @db.Timestamptz(6)
  updated_at          DateTime           @default(now()) @updatedAt @db.Timestamptz(6)
  birth_chart_version Int?               @default(0)
  synastry_reports    synastry_reports[]

  @@index([user_id], map: "idx_relationship_profiles_user_id")
  @@index([relationship_type], map: "idx_relationship_profiles_type")
}

model synastry_reports {
  id                      String                @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id                 String
  relationship_profile_id String                @db.Uuid
  compatibility_score     Int?
  synastry_aspects        Json?
  composite_chart         Json?
  element_balance         Json?
  modality_balance        Json?
  analysis_summary        String?
  calculated_at           DateTime              @default(now()) @db.Timestamptz(6)
  updated_at              DateTime              @default(now()) @updatedAt @db.Timestamptz(6)
  relationship_profile    relationship_profiles @relation(fields: [relationship_profile_id], references: [id], onDelete: Cascade)

  @@index([user_id], map: "idx_synastry_reports_user_id")
  @@index([relationship_profile_id], map: "idx_synastry_reports_profile_id")
}

model friend_invites {
  id             String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  inviter_id     String
  invite_code    String    @unique
  status         String    @default("pending")
  accepted_by_id String?
  expires_at     DateTime  @db.Timestamptz(6)
  created_at     DateTime  @default(now()) @db.Timestamptz(6)
  accepted_at    DateTime? @db.Timestamptz(6)

  @@index([inviter_id], map: "idx_friend_invites_inviter")
  @@index([invite_code], map: "idx_friend_invites_code")
  @@index([status], map: "idx_friend_invites_status")
}

model friend_connections {
  id                 String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id            String
  friend_id          String
  nickname           String?
  relationship_type  String?
  synastry_score     Int?
  synastry_data      Json?
  last_synastry_calc DateTime? @db.Timestamptz(6)
  created_at         DateTime  @default(now()) @db.Timestamptz(6)
  updated_at         DateTime  @default(now()) @updatedAt @db.Timestamptz(6)

  @@unique([user_id, friend_id], map: "idx_friend_connections_unique")
  @@index([user_id], map: "idx_friend_connections_user")
  @@index([friend_id], map: "idx_friend_connections_friend")
}

model friend_celebrations {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  sender_id   String
  receiver_id String
  milestone   Int
  message     String?
  created_at  DateTime @default(now()) @db.Timestamptz(6)

  @@index([receiver_id, created_at(sort: Desc)], map: "idx_celebrations_receiver")
  @@index([sender_id, receiver_id, milestone], map: "idx_celebrations_sender")
}

model verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime @db.Timestamptz(6)
  createdAt  DateTime @default(now()) @db.Timestamptz(6)
  updatedAt  DateTime @default(now()) @db.Timestamptz(6)
}

model video_jobs {
  id         Int       @id @default(autoincrement())
  script_id  Int       @unique(map: "idx_video_jobs_script_id")
  week_start DateTime? @db.Date
  date_key   DateTime? @db.Date
  topic      String?
  status     String    @default("pending")
  attempts   Int       @default(0)
  last_error String?
  created_at DateTime? @default(now()) @db.Timestamptz(6)
  updated_at DateTime? @default(now()) @db.Timestamptz(6)

  @@unique([week_start, date_key, topic], map: "idx_video_jobs_week_topic")
}

model video_scripts {
  id                   Int       @id @default(autoincrement())
  theme_id             String
  theme_name           String
  facet_title          String
  platform             String
  sections             Json
  full_script          String
  word_count           Int
  estimated_duration   String
  scheduled_date       DateTime  @db.Date
  status               String    @default("draft")
  metadata             Json?
  cover_image_url      String?
  part_number          Int?
  created_at           DateTime? @default(now()) @db.Timestamptz(6)
  updated_at           DateTime? @default(now()) @db.Timestamptz(6)
  written_post_content String?
  topic                String?
  angle                String?
  aspect               String?
  primary_theme_id     String?
  hook_text            String?
  hook_version         Int?      @default(1)

  @@index([platform], map: "idx_video_scripts_platform")
  @@index([scheduled_date], map: "idx_video_scripts_scheduled")
  @@index([status], map: "idx_video_scripts_status")
}

model videos {
  id               String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  type             String    @db.VarChar(20)
  video_url        String
  thumbnail_url    String?
  title            String?
  description      String?
  week_number      Int?
  blog_slug        String?
  status           String?   @default("pending") @db.VarChar(20)
  youtube_video_id String?
  created_at       DateTime? @default(now()) @db.Timestamptz(6)
  expires_at       DateTime? @default(dbgenerated("(now() + '7 days'::interval)")) @db.Timestamptz(6)
  post_content     String?
  audio_url        String?
  updated_at       DateTime? @default(now()) @db.Timestamptz(6)
  script           String?

  @@index([created_at(sort: Desc)], map: "idx_videos_created_at")
  @@index([expires_at], map: "idx_videos_expires_at")
  @@index([status], map: "idx_videos_status")
  @@index([type, week_number], map: "idx_videos_type_week")
}

model weekly_ritual_usage {
  id           Int       @id @default(autoincrement())
  user_id      String
  week_start   DateTime  @db.Date
  ritual_count Int?      @default(0)
  created_at   DateTime? @default(now()) @db.Timestamptz(6)
  updated_at   DateTime? @default(now()) @db.Timestamptz(6)

  @@unique([user_id, week_start])
  @@index([user_id, week_start], map: "idx_weekly_ritual_usage_user_week")
}

model year_analysis {
  user_id           String
  year              Int
  analysis_data     Json
  created_at        DateTime? @default(now()) @db.Timestamptz(6)
  updated_at        DateTime? @default(now()) @db.Timestamptz(6)
  card_recaps       Json?
  trends            Json?
  last_reading_date DateTime? @db.Timestamptz(6)

  @@id([user_id, year])
  @@index([updated_at], map: "idx_year_analysis_updated_at")
  @@index([user_id], map: "idx_year_analysis_user_id")
  @@index([year], map: "idx_year_analysis_year")
}

model yearly_forecasts {
  year         Int       @id
  summary      String?
  forecast     Json
  stats        Json?
  source       String?   @default("manual")
  generated_at DateTime? @default(now()) @db.Timestamptz(6)
  expires_at   DateTime? @db.Timestamptz(6)
  created_at   DateTime? @default(now()) @db.Timestamptz(6)
  updated_at   DateTime? @default(now()) @db.Timestamptz(6)

  @@index([generated_at], map: "idx_yearly_forecasts_generated_at")
  @@index([updated_at], map: "idx_yearly_forecasts_updated_at")
}

model youtube_uploads {
  id               Int       @id @default(autoincrement())
  topic            String
  scheduled_date   DateTime  @db.Date
  video_url        String
  youtube_video_id String?
  status           String    @default("pending")
  error            String?
  created_at       DateTime? @default(now()) @db.Timestamptz(6)

  @@unique([topic, scheduled_date])
}

model feature_announcements {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  title         String
  description   String
  icon          String   @default("Sparkles")
  cta_label     String?
  cta_href      String?
  required_tier String[] @default([])
  is_active     Boolean  @default(true)
  released_at   DateTime @default(now()) @db.Timestamptz(6)
  created_at    DateTime @default(now()) @db.Timestamptz(6)
  updated_at    DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  @@index([is_active], map: "idx_feature_announcements_active")
  @@index([released_at], map: "idx_feature_announcements_released")
}

model feature_announcements_seen {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id         String
  announcement_id String
  seen_at         DateTime @default(now()) @db.Timestamptz(6)

  @@unique([user_id, announcement_id])
  @@index([user_id], map: "idx_feature_announcements_seen_user_id")
}

model orphaned_subscriptions {
  id                     Int       @id @default(autoincrement())
  stripe_subscription_id String    @unique
  stripe_customer_id     String
  customer_email         String?
  status                 String
  plan_type              String?
  subscription_metadata  Json?
  resolved               Boolean?  @default(false)
  resolved_user_id       String?
  resolved_at            DateTime? @db.Timestamptz(6)
  resolved_by            String?
  notes                  String?
  created_at             DateTime? @default(now()) @db.Timestamptz(6)
  updated_at             DateTime? @default(now()) @db.Timestamptz(6)

  @@index([stripe_customer_id], map: "idx_orphaned_subscriptions_customer_id")
  @@index([customer_email], map: "idx_orphaned_subscriptions_email")
  @@index([resolved], map: "idx_orphaned_subscriptions_resolved")
  @@index([created_at], map: "idx_orphaned_subscriptions_created_at")
}

model stripe_webhook_events {
  id                     String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  event_id               String    @unique
  event_type             String
  processing_status      String    @default("pending")
  user_id                String?
  stripe_customer_id     String?
  stripe_subscription_id String?
  raw_payload            Json?
  retry_count            Int?      @default(0)
  failure_reason         String?
  created_at             DateTime? @default(now()) @db.Timestamptz(6)
  processed_at           DateTime? @db.Timestamptz(6)
  updated_at             DateTime? @default(now()) @db.Timestamptz(6)

  @@index([event_id], map: "idx_stripe_webhook_events_event_id")
  @@index([event_type], map: "idx_stripe_webhook_events_event_type")
  @@index([processing_status], map: "idx_stripe_webhook_events_status")
  @@index([user_id], map: "idx_stripe_webhook_events_user_id")
  @@index([created_at], map: "idx_stripe_webhook_events_created_at")
}

model subscription_audit_log {
  id              Int       @id @default(autoincrement())
  user_id         String
  event_type      String
  old_state       Json?
  new_state       Json?
  source          String
  stripe_event_id String?
  created_by      String?
  created_at      DateTime? @default(now()) @db.Timestamptz(6)

  @@index([user_id], map: "idx_subscription_audit_log_user_id")
  @@index([event_type], map: "idx_subscription_audit_log_event_type")
  @@index([created_at], map: "idx_subscription_audit_log_created_at")
  @@index([stripe_event_id], map: "idx_subscription_audit_log_stripe_event_id")
}

/// Tracks pending checkout sessions to prevent duplicate subscriptions
/// This is a critical safeguard against race conditions
model pending_checkouts {
  id                  Int       @id @default(autoincrement())
  user_id             String    @unique
  checkout_session_id String?
  price_id            String
  status              String    @default("pending")
  created_at          DateTime  @default(now()) @db.Timestamptz(6)
  expires_at          DateTime  @db.Timestamptz(6)
  completed_at        DateTime? @db.Timestamptz(6)

  @@index([user_id], map: "idx_pending_checkouts_user_id")
  @@index([status], map: "idx_pending_checkouts_status")
  @@index([expires_at], map: "idx_pending_checkouts_expires_at")
}

/// Metric snapshots for analytics - stores weekly and monthly aggregated metrics
model metric_snapshots {
  period_type                   String   @db.VarChar(20)
  period_key                    String   @db.VarChar(50)
  period_start                  DateTime @db.Date
  period_end                    DateTime @db.Date
  new_signups                   Int
  new_trials                    Int
  new_paying_subscribers        Int
  wau                           Int
  activation_rate               Float    @db.Real
  trial_to_paid_conversion_rate Float    @db.Real
  mrr                           Float    @db.Real
  active_subscribers            Int
  churn_rate                    Float    @db.Real
  d7_retention                  Float?   @db.Real
  extras                        Json?
  created_at                    DateTime @default(now()) @db.Timestamptz(6)
  updated_at                    DateTime @default(now()) @db.Timestamptz(6)

  @@id([period_type, period_key])
  @@index([period_type], map: "idx_metric_snapshots_period_type")
  @@index([period_start], map: "idx_metric_snapshots_period_start")
}

model native_push_tokens {
  id                     Int       @id @default(autoincrement())
  user_id                String
  token                  String
  platform               String
  timezone               String?
  is_active              Boolean?  @default(true)
  preferences            Json?     @default("{}")
  last_notification_sent DateTime? @db.Timestamptz(6)
  created_at             DateTime? @default(now()) @db.Timestamptz(6)
  updated_at             DateTime? @default(now()) @db.Timestamptz(6)

  @@unique([user_id, platform])
  @@index([is_active], map: "idx_native_push_active")
  @@index([user_id], map: "idx_native_push_user")
  @@index([platform], map: "idx_native_push_platform")
}

/// Stores scheduled Instagram content generated by the content orchestrator
/// Each post includes caption, image URL, and metadata for publishing
/// Community spaces: transit-based support groups, sign lounges, retrograde check-ins
/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model community_spaces {
  id                    Int                     @id @default(autoincrement())
  space_type            String
  slug                  String                  @unique
  title                 String
  description           String?
  sign                  String?
  planet                String?
  metadata              Json?                   @default("{}")
  is_active             Boolean?                @default(true)
  starts_at             DateTime?               @db.Timestamptz(6)
  ends_at               DateTime?               @db.Timestamptz(6)
  post_count            Int?                    @default(0)
  member_count          Int?                    @default(0)
  created_at            DateTime?               @default(now()) @db.Timestamptz(6)
  updated_at            DateTime?               @default(now()) @db.Timestamptz(6)
  community_memberships community_memberships[]
  community_posts       community_posts[]

  @@index([space_type], map: "idx_community_spaces_type")
  @@index([slug], map: "idx_community_spaces_slug")
  @@index([is_active], map: "idx_community_spaces_active")
}

/// Community posts within spaces
/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model community_posts {
  id               Int              @id @default(autoincrement())
  space_id         Int
  user_id          String
  post_text        String
  is_anonymous     Boolean?         @default(true)
  is_approved      Boolean?         @default(true)
  post_type        String?          @default("insight") @db.VarChar(30)
  parent_id        Int?
  vote_count       Int?             @default(0)
  best_answer      Boolean?         @default(false)
  topic_tag        String?          @db.VarChar(30)
  attachment       Json?
  created_at       DateTime?        @default(now()) @db.Timestamptz(6)
  community_spaces community_spaces @relation(fields: [space_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  parent           community_posts? @relation("PostReplies", fields: [parent_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  replies          community_posts[] @relation("PostReplies")
  community_votes  community_votes[]

  @@index([space_id, created_at(sort: Desc)], map: "idx_community_posts_space")
  @@index([user_id], map: "idx_community_posts_user")
  @@index([space_id, is_approved, created_at(sort: Desc)], map: "idx_community_posts_approved")
  @@index([post_type], map: "idx_community_posts_type")
  @@index([parent_id], map: "idx_community_posts_parent")
  @@index([vote_count(sort: Desc)], map: "idx_community_posts_votes")
}

/// Community post votes (upvotes for Q&A)
model community_votes {
  id         Int              @id @default(autoincrement())
  post_id    Int
  user_id    String
  vote       Int              @default(1) @db.SmallInt
  created_at DateTime?        @default(now()) @db.Timestamptz(6)
  post       community_posts  @relation(fields: [post_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([post_id, user_id])
  @@index([post_id], map: "idx_community_votes_post")
  @@index([user_id], map: "idx_community_votes_user")
}

/// Community space memberships
model community_memberships {
  id               Int              @id @default(autoincrement())
  space_id         Int
  user_id          String
  joined_at        DateTime?        @default(now()) @db.Timestamptz(6)
  community_spaces community_spaces @relation(fields: [space_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([space_id, user_id])
  @@index([user_id], map: "idx_community_memberships_user")
  @@index([space_id], map: "idx_community_memberships_space")
}

/// User blocks for hiding content from specific users
model blocked_users {
  id          Int       @id @default(autoincrement())
  blocker_id  String
  blocked_id  String
  created_at  DateTime? @default(now()) @db.Timestamptz(6)

  @@unique([blocker_id, blocked_id])
  @@index([blocker_id], map: "idx_blocked_users_blocker")
  @@index([blocked_id], map: "idx_blocked_users_blocked")
}

/// Content reports for community UGC (posts, questions, answers)
/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model content_reports {
  id           Int       @id @default(autoincrement())
  reporter_id  String
  content_type String
  content_id   Int
  reason       String
  details      String?
  status       String    @default("pending")
  reviewed_at  DateTime? @db.Timestamptz(6)
  created_at   DateTime? @default(now()) @db.Timestamptz(6)

  @@unique([reporter_id, content_type, content_id])
  @@index([status, created_at(sort: Desc)], map: "idx_content_reports_status")
  @@index([content_type, content_id], map: "idx_content_reports_content")
}

model instagram_scheduled_posts {
  id             Int       @id @default(autoincrement())
  date           DateTime  @db.Date
  type           String    @db.VarChar(50)
  scheduled_time DateTime  @db.Timestamptz(6)
  caption        String
  image_url      String?
  hashtags       String[]
  metadata       Json?     @default("{}")
  posted         Boolean?  @default(false)
  posted_at      DateTime? @db.Timestamptz(6)
  post_id        String?   @db.VarChar(255)
  created_at     DateTime  @default(now()) @db.Timestamptz(6)
  updated_at     DateTime  @default(now()) @updatedAt @db.Timestamptz(6)

  @@unique([date, type, scheduled_time], map: "instagram_scheduled_posts_unique")
  @@index([date], map: "idx_instagram_scheduled_posts_date")
  @@index([scheduled_time], map: "idx_instagram_scheduled_posts_scheduled_time")
  @@index([posted], map: "idx_instagram_scheduled_posts_posted")
  @@index([type], map: "idx_instagram_scheduled_posts_type")
  @@index([date, type], map: "idx_instagram_scheduled_posts_date_type")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model daily_metrics {
  metric_date                 DateTime  @id @db.Date
  dau                         Int       @default(0)
  wau                         Int       @default(0)
  mau                         Int       @default(0)
  signed_in_product_dau       Int       @default(0)
  signed_in_product_wau       Int       @default(0)
  signed_in_product_mau       Int       @default(0)
  app_opened_mau              Int       @default(0)
  new_signups                 Int       @default(0)
  activated_users             Int       @default(0)
  activation_rate             Decimal?  @default(0) @db.Decimal(5, 2)
  mrr                         Decimal?  @default(0) @db.Decimal(10, 2)
  active_subscriptions        Int?      @default(0)
  trial_subscriptions         Int?      @default(0)
  new_conversions             Int?      @default(0)
  stickiness                  Decimal?  @default(0) @db.Decimal(5, 2)
  avg_active_days_per_week    Decimal?  @default(0) @db.Decimal(5, 2)
  dashboard_adoption          Decimal?  @default(0) @db.Decimal(5, 2)
  horoscope_adoption          Decimal?  @default(0) @db.Decimal(5, 2)
  tarot_adoption              Decimal?  @default(0) @db.Decimal(5, 2)
  chart_adoption              Decimal?  @default(0) @db.Decimal(5, 2)
  guide_adoption              Decimal?  @default(0) @db.Decimal(5, 2)
  ritual_adoption             Decimal?  @default(0) @db.Decimal(5, 2)
  computed_at                 DateTime? @default(now()) @db.Timestamp(6)
  computation_duration_ms     Int?
  created_at                  DateTime? @default(now()) @db.Timestamp(6)
  app_opened_dau              Int       @default(0)
  app_opened_wau              Int       @default(0)
  returning_dau               Int       @default(0)
  returning_wau               Int       @default(0)
  returning_mau               Int       @default(0)
  reach_dau                   Int       @default(0)
  reach_wau                   Int       @default(0)
  reach_mau                   Int       @default(0)
  grimoire_dau                Int       @default(0)
  grimoire_wau                Int       @default(0)
  grimoire_mau                Int       @default(0)
  grimoire_only_mau           Int       @default(0)
  d1_retention                Decimal?  @default(0) @db.Decimal(5, 2)
  d7_retention                Decimal?  @default(0) @db.Decimal(5, 2)
  d30_retention               Decimal?  @default(0) @db.Decimal(5, 2)
  active_days_1               Int       @default(0)
  active_days_2_3             Int       @default(0)
  active_days_4_7             Int       @default(0)
  active_days_8_14            Int       @default(0)
  active_days_15_plus         Int       @default(0)
  stickiness_wau_mau          Decimal?  @default(0) @db.Decimal(5, 2)
  total_accounts              Int       @default(0)
  grimoire_to_app_rate        Decimal?  @default(0) @db.Decimal(5, 2)
  grimoire_to_app_users       Int       @default(0)
  returning_referrer_organic  Int?      @default(0)
  returning_referrer_direct   Int?      @default(0)
  returning_referrer_internal Int?      @default(0)

  @@index([metric_date(sort: Desc)], map: "idx_daily_metrics_date")
  @@index([metric_date(sort: Desc), computed_at(sort: Desc)], map: "idx_daily_metrics_date_computed")
}

/// Phase 3: Daily ritual tracking (morning + evening)
model daily_rituals {
  id                 Int       @id @default(autoincrement())
  user_id            String
  ritual_date        DateTime  @db.Date
  ritual_type        String    @db.VarChar(20)

  // Morning fields
  cosmic_score       Int?
  card_pulled        Json?
  intention_id       String?   @db.Uuid
  crystal_color      Json?

  // Evening fields
  mood               String?   @db.VarChar(50)
  mood_moon_phase    String?
  gratitude          String?
  intention_reviewed Boolean?  @default(false)
  intention_outcome  String?   @db.VarChar(30)
  dream_intention    String?

  created_at         DateTime? @default(now()) @db.Timestamptz(6)

  @@unique([user_id, ritual_date, ritual_type])
  @@index([user_id], map: "idx_daily_rituals_user")
  @@index([ritual_date], map: "idx_daily_rituals_date")
}

/// Phase 3: Weekly transit-based challenges
model weekly_challenges {
  id                    Int                     @id @default(autoincrement())
  week_start            DateTime                @unique @db.Date
  transit_key           String                  @db.VarChar(100)
  challenge_title       String                  @db.VarChar(200)
  challenge_description String
  daily_prompts         Json                    @default("[]")
  xp_per_day            Int                     @default(1)
  xp_bonus_week         Int                     @default(5)
  participant_count     Int                     @default(0)
  created_at            DateTime?               @default(now()) @db.Timestamptz(6)
  challenge_completions challenge_completions[]

  @@index([week_start], map: "idx_weekly_challenges_week")
}

/// Phase 3: User check-ins for weekly challenges
model challenge_completions {
  id               Int               @id @default(autoincrement())
  user_id          String
  challenge_id     Int
  check_in_date    DateTime          @db.Date
  completed        Boolean?          @default(false)
  reflection       String?
  created_at       DateTime?         @default(now()) @db.Timestamptz(6)
  weekly_challenge weekly_challenges @relation(fields: [challenge_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([user_id, challenge_id, check_in_date])
  @@index([user_id, challenge_id], map: "idx_challenge_completions_user_challenge")
}

/// Phase 3: Cosmic milestone achievements (solar return, app anniversary, streaks, etc.)
model milestones_achieved {
  id             Int       @id @default(autoincrement())
  user_id        String
  milestone_type String    @db.VarChar(50)
  milestone_key  String    @db.VarChar(100)
  milestone_data Json?     @default("{}")
  achieved_at    DateTime? @db.Timestamptz(6)
  notified_at    DateTime? @db.Timestamptz(6)
  celebrated     Boolean?  @default(false)
  created_at     DateTime? @default(now()) @db.Timestamptz(6)

  @@unique([user_id, milestone_key])
  @@index([user_id], map: "idx_milestones_user")
  @@index([celebrated], map: "idx_milestones_celebrated")
}

/// Phase 3: Cosmic gifts between friends
/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model cosmic_gifts {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  sender_id    String
  recipient_id String
  gift_type    String
  content      Json      @default("{}")
  message      String?
  opened_at    DateTime? @db.Timestamptz(6)
  created_at   DateTime  @default(now()) @db.Timestamptz(6)

  @@index([sender_id, created_at(sort: Desc)], map: "idx_cosmic_gifts_sender")
  @@index([recipient_id, created_at(sort: Desc)], map: "idx_cosmic_gifts_recipient")
}

model PodcastEpisode {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  episodeNumber Int      @unique @map("episode_number")
  slug          String   @unique
  title         String
  description   String
  audioUrl      String   @map("audio_url")
  durationSecs  Int      @map("duration_secs")
  publishedAt   DateTime @map("published_at") @db.Timestamptz(6)
  weekNumber    Int?     @map("week_number")
  year          Int?
  transcript    Json?
  showNotes     Json?    @map("show_notes")
  grimoireSlugs String[] @map("grimoire_slugs")
  status        String   @default("published") @db.VarChar(20)
  podifyJobId   String?  @map("podify_job_id")
  youtubeVideoId  String?  @map("youtube_video_id")
  youtubeVideoUrl String?  @map("youtube_video_url")
  videoUrl        String?  @map("video_url")
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([status, publishedAt(sort: Desc)])
  @@index([weekNumber, year])
  @@map("podcast_episodes")
}

enum tour_status {
  ACTIVE
  COMPLETED
  DISMISSED
}
